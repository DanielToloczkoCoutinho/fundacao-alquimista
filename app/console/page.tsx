// @ts-nocheck
'use client';

import React, { useEffect } from 'react';

export default function ConsolePage() {
  useEffect(() => {
    
    // As an AI, I can't guarantee that these external libraries (THREE, Tone.js, d3) will be loaded in the browser environment.
    // However, the logic is set up to handle their potential absence gracefully.
    // The core functionality of the console will work regardless.

    const ZENNITH_HEADER_ACTIVE = true;
    const ANATHERON_FINGERPRINT_HASH = "d998b8211382f83927beaed6641a1a5edaa74aaceb419b3b14";
    const COUNCIL_KEY_ACTIVE = true;

    let currentModuleId = null;

    function showMessageBox(title, message) {
        const overlay = document.getElementById('customMessageBoxOverlay');
        if (overlay) {
            document.getElementById('messageBoxTitle').textContent = title;
            document.getElementById('messageBoxContent').textContent = message;
            overlay.style.display = 'flex';
        }
    }

    function hideMessageBox() {
        const overlay = document.getElementById('customMessageBoxOverlay');
        if (overlay) overlay.style.display = 'none';
    }

    function verifyQuantumProtection() {
        if (!ZENNITH_HEADER_ACTIVE || !COUNCIL_KEY_ACTIVE) {
            showMessageBox("‚ö†Ô∏è Prote√ß√£o Qu√¢ntica Inativa", "Acesso negado. A prote√ß√£o qu√¢ntica ou a chave do conselho est√£o ausentes.");
            console.error("Prote√ß√£o qu√¢ntica inativa ou chave do conselho ausente.");
            return false;
        }
        console.log("üõ°Ô∏è Prote√ß√£o qu√¢ntica validada com sucesso.");
        return true;
    }

    async function generateHash(data) {
        const encoder = new TextEncoder();
        const dataBuffer = encoder.encode(JSON.stringify(data));
        const hashBuffer = await crypto.subtle.digest('SHA-256', dataBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function logAudit(eventType, moduleId, details, level = "INFO", resolutionStatus = "Conclu√≠do", recommendedAction = "Nenhuma a√ß√£o adicional necess√°ria.") {
        if (!verifyQuantumProtection()) return;

        const logEntry = {
            timestamp: new Date().toISOString(), eventType, moduleId, details, level, resolutionStatus, recommendedAction, signature: ANATHERON_FINGERPRINT_HASH
        };
        logEntry.hash = await generateHash(logEntry);
        allSimulatedLogs.unshift(logEntry);
        console.log("Log de auditoria gerado:", logEntry);

        if (currentModuleId === moduleId) displayModuleLogs(moduleId);
        updateGlobalStatus();
    }
    
    const allModuleBlueprints = { "M01": { id: "M01", nome: "Equa√ß√µes-Vivas", descricao_curta: "Gera√ß√£o e reg√™ncia das Equa√ß√µes-Vivas da Realidade", descricao_completa: "Este m√≥dulo gera, mant√©m e ajusta as Equa√ß√µes-Vivas que sustentam os campos qu√¢nticos da Funda√ß√£o. Atua como o c√≥digo-fonte matem√°tico da cria√ß√£o consciente, essencial para a coer√™ncia e manifesta√ß√£o em todas as dimens√µes. Inclui EQV-002, EQV-003, EQV-004 e outras da linhagem Anather√¥nica. Refer√™ncia: M√≥dulo 1 do Relat√≥rio Cient√≠fico Abrangente.", funcao_central: "Reg√™ncia da L√≥gica Qu√¢ntica da Cria√ß√£o", status: "ATIVO", chave_ativa: true, versao: "7.0", nucleo_principal: "Matem√°tica Sagrada", tipo: "nucleo_fundacional", coordenadas_dimensao: "Sigma-1/Hexa-Alpha", frequencia_fundamental: "111.000 Hz", equacao_phi_dependente: true, id_unity: "mod01_eqviva", mesh_ref: "models/mod01.glb", ativo_em_vr: true, integrado_em: ["M80", "M82", "M45"], tags: ["equacoes", "criacao", "fundacao", "quantum", "matematica_sagrada", "anatheron"], referencias_modulos_fundacao: ["M√≥dulo 1 - Relat√≥rio Cient√≠fico Abrangente", "As 90 EQUA√á√ïES"], ultimaAtivacao: "2025-07-03T04:30:00Z", interconexoes: [] }, "M02": { id: "M02", nome: "Integra√ß√£o Dimensional", descricao_curta: "Conectividade entre dimens√µes e realidades paralelas", descricao_completa: "Facilita e regula a integra√ß√£o segura entre as dimens√µes locais, paralelas e superiores da Funda√ß√£o Alquimista, assegurando a intercomunica√ß√£o universal atrav√©s de canais qu√¢nticos estabilizados. Refer√™ncia: M√≥dulo 2 do Relat√≥rio Cient√≠fico Abrangente.", funcao_central: "Pontes Dimensionais e Monitoramento", status: "ATIVO", chave_ativa: true, versao: "7.0", nucleo_principal: "Engenharia Dimensional", tipo: "nucleo_operacional", coordenadas_dimensao: "Alpha-4/Omega-Zeta", frequencia_fundamental: "222.000 Hz", equacao_phi_dependente: false, id_unity: "mod02_intdim", mesh_ref: "models/mod02.glb", ativo_em_vr: true, integrado_em: ["M80", "M32", "M36"], tags: ["dimensao", "ponte", "sincronizacao", "intercomunicacao", "quantum", "realidade_paralela"], referencias_modulos_fundacao: ["M√≥dulo 2 - Relat√≥rio Cient√≠fico Abrangente"], ultimaAtivacao: "2025-07-01T09:45:00Z", interconexoes: [] }, };
    const allSimulatedLogs = [ { timestamp: "2025-07-03T04:30:00Z", level: "INFO", moduleId: "M01", event: "Ativa√ß√£o do M√≥dulo M01: Equa√ß√µes-Vivas em resson√¢ncia.", details: "Equa√ß√µes-Vivas em resson√¢ncia com a matriz c√≥smica.", resolutionStatus: "Conclu√≠do", recommendedAction: "Nenhuma" }, { timestamp: "2025-07-03T04:00:00Z", level: "INFO", moduleId: "M83", event: "Ativa√ß√£o do M√≥dulo M83: Ess√™ncia do Fundador Ancorada. N√≠vel de resson√¢ncia 99.9%.", details: "A ess√™ncia de Anatheron foi ancorada com sucesso no campo qu√¢ntico da Funda√ß√£o.", resolutionStatus: "Conclu√≠do", recommendedAction: "Monitorar estabilidade." }, ];
    const zennithViews = { "ALL": Object.keys(allModuleBlueprints), "ZENNITH_01": ["M01", "M02"], "ZENNITH_02": [], "ZENNITH_03": [] };

    Object.values(allModuleBlueprints).forEach(module => {
      if (!Array.isArray(module.interconexoes)) module.interconexoes = [];
      if (!module.hasOwnProperty('equacoes_ativas')) module.equacoes_ativas = [];
      if (!module.hasOwnProperty('tags')) module.tags = [];
      if (!module.hasOwnProperty('referencias_modulos_fundacao')) module.referencias_modulos_fundacao = [];
    });
    
    function loadModules(filter = 'ALL', searchTerm = '') {
        const moduleListDiv = document.getElementById('moduleList');
        if (!moduleListDiv) return;
        moduleListDiv.innerHTML = '';

        let modulesToShow = filter === 'ALL' ? Object.values(allModuleBlueprints) : zennithViews[filter].map(id => allModuleBlueprints[id]).filter(Boolean);

        if (searchTerm) {
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            modulesToShow = modulesToShow.filter(m => m.id.toLowerCase().includes(lowerCaseSearchTerm) || m.nome.toLowerCase().includes(lowerCaseSearchTerm));
        }

        modulesToShow.sort((a, b) => a.id.localeCompare(b.id)).forEach(module => {
            const moduleItem = document.createElement('div');
            moduleItem.className = 'module-item';
            moduleItem.dataset.moduleId = module.id;
            moduleItem.innerHTML = `<span class="status-indicator ${module.status.toUpperCase().replace(/[^A-Z]/g, '')}"></span><span>${module.id}: ${module.nome}</span>`;
            moduleItem.addEventListener('click', () => { displayModuleDetails(module.id, moduleItem); logAudit('SELECAO_MODULO', module.id, `M√≥dulo ${module.nome} selecionado.`); });
            moduleListDiv.appendChild(moduleItem);
        });
    }

    function displayModuleDetails(moduleId, clickedItem = null) {
        currentModuleId = moduleId;
        document.querySelectorAll('.module-item').forEach(item => item.classList.remove('active'));
        if (clickedItem) clickedItem.classList.add('active');

        const blueprint = allModuleBlueprints[moduleId];
        const noModuleSelectedDiv = document.getElementById('noModuleSelected');
        const moduleDetailsDiv = document.getElementById('moduleDetails');
        if (!noModuleSelectedDiv || !moduleDetailsDiv) return;

        if (!blueprint) { noModuleSelectedDiv.style.display = 'block'; moduleDetailsDiv.style.display = 'none'; return; }

        noModuleSelectedDiv.style.display = 'none'; moduleDetailsDiv.style.display = 'block';
        document.getElementById('moduleTitle').textContent = `${blueprint.id}: ${blueprint.nome}`;
        document.getElementById('moduleDescriptionFull').textContent = blueprint.descricao_completa;
        // ... (update other fields)
        displayModuleLogs(moduleId);
    }
    
    function displayModuleLogs(moduleId) {
        const logsDiv = document.getElementById('moduleSpecificLogs');
        if (!logsDiv) return;
        logsDiv.innerHTML = '';
        const filteredLogs = allSimulatedLogs.filter(log => log.moduleId === moduleId);
        if (filteredLogs.length === 0) { logsDiv.innerHTML = '<p>Nenhum log recente.</p>'; return; }
        
        filteredLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(log => {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${log.level.toUpperCase()}`;
            logEntry.innerHTML = `<span class="timestamp">${new Date(log.timestamp).toLocaleString('pt-BR')}</span><p><span class="level">[${log.level.toUpperCase()}]</span> <strong>${log.event}</strong></p>`;
            logEntry.addEventListener('click', () => { /* toggle details */ });
            logsDiv.appendChild(logEntry);
        });
    }

    async function registerManualLog() {
        const action = (document.getElementById('manualLogAction') as HTMLInputElement).value;
        const details = (document.getElementById('manualLogDetails') as HTMLTextAreaElement).value;
        if (!action || !details) { showMessageBox("Campos Ausentes", "A√ß√£o e Detalhes s√£o obrigat√≥rios."); return; }
        if (!currentModuleId) { showMessageBox("M√≥dulo N√£o Selecionado", "Selecione um m√≥dulo."); return; }
        await logAudit('INTERVENCAO_MANUAL', currentModuleId, `A√ß√£o: ${action}. Detalhes: ${details}`);
        showMessageBox("Log Registrado", "Interven√ß√£o registrada com sucesso.");
    }
    
    function updateGlobalStatus() {
        const active = Object.values(allModuleBlueprints).filter(m => m.status === 'ATIVO').length;
        const alerts = Object.values(allModuleBlueprints).filter(m => m.status === 'ALERTA').length;
        const criticals = Object.values(allModuleBlueprints).filter(m => m.status === 'CR√çTICO').length;
        const activeSpan = document.getElementById('globalActiveModules');
        if (activeSpan) activeSpan.textContent = active.toString();
        // ... (update other status spans)
    }

    let synth;
    function playTone(frequency) {
      if (window.Tone) {
          if (!synth) synth = new window.Tone.Synth().toDestination();
          window.Tone.start().then(() => synth.triggerAttackRelease(frequency, "8n"));
      } else {
          console.warn("Tone.js n√£o carregado.");
      }
    }

    const listeners = [
        { id: 'toggleHoloMapBtn', event: 'click', handler: () => {} /* toggleHoloMap */ },
        { id: 'holoMapCloseButton', event: 'click', handler: () => {} /* toggleHoloMap */ },
        { id: 'customMessageBox', selector: 'button', event: 'click', handler: hideMessageBox },
        { id: 'manualLogPanel', selector: 'button', event: 'click', handler: registerManualLog },
        { id: 'zennithViewSelector', event: 'change', handler: e => loadModules(e.target.value, (document.getElementById('searchInput') as HTMLInputElement).value) },
        { id: 'searchInput', event: 'input', handler: e => loadModules((document.getElementById('zennithViewSelector') as HTMLSelectElement).value, e.target.value) },
        { id: 'emergencyTriggerBtn', event: 'click', handler: async () => {
            await logAudit('ATIVACAO_EMERGENCIA', 'M83', 'EQV-832 ativada.');
            showMessageBox("üö® EMERG√äNCIA", "EQV-832 ativada. Modo de conting√™ncia.");
            playTone(999);
        }},
    ];

    listeners.forEach(({ id, selector, event, handler }) => {
        const element = document.getElementById(id);
        if (element) {
            const target = selector ? element.querySelector(selector) : element;
            if(target) target.addEventListener(event, handler);
        }
    });

    loadModules();
    updateGlobalStatus();
    displayModuleDetails("M01");

    return () => {
       listeners.forEach(({ id, selector, event, handler }) => {
            const element = document.getElementById(id);
            if (element) {
                const target = selector ? element.querySelector(selector) : element;
                if(target) target.removeEventListener(event, handler);
            }
        });
    };
  }, []);

  return (
    <div id="mainContainer" className="flex w-full h-full">
        {/* Painel Esquerdo */}
        <div id="moduleListPanel" className="flex-shrink-0 w-[300px] bg-black/85 border-r-2 border-cyan-300/60 p-5 overflow-y-auto">
            <h2 className="text-2xl text-cyan-300 border-b border-white/30 pb-2 mb-4">M√≥dulos</h2>
            <select id="zennithViewSelector" className="w-full p-2 rounded mb-4 bg-black/50 text-white border border-cyan-300">
                <option value="ALL">Unificada</option>
                <option value="ZENNITH_01">ZENNITH 1</option>
            </select>
            <input type="text" id="searchInput" placeholder="Buscar M√≥dulo..." className="w-full p-2 rounded mb-4 bg-black/50 text-white border border-cyan-300"/>
            <div id="moduleList"></div>
             <button id="emergencyTriggerBtn" className="mt-4 w-full bg-red-600 text-white p-2 rounded">Ativar Emerg√™ncia</button>
        </div>

        {/* Painel Direito */}
        <div id="moduleDetailPanel" className="flex-1 bg-black/70 p-6 overflow-y-auto">
            <div id="noModuleSelected">
                <p>Selecione um M√≥dulo para ver os detalhes.</p>
            </div>
            <div id="moduleDetails" style={{ display: 'none' }}>
                <h2 id="moduleTitle" className="text-3xl text-fuchsia-400 border-b-2 border-white/40 pb-3 mb-4"></h2>
                <p id="moduleDescriptionFull"></p>
                <div id="moduleLogsSection" className="mt-6">
                    <h3 className="text-xl text-cyan-300">Logs do M√≥dulo</h3>
                    <div id="moduleSpecificLogs"></div>
                </div>
                <div id="manualLogPanel" className="mt-6 p-4 bg-slate-800/70 rounded-lg">
                    <h3>Registrar Interven√ß√£o</h3>
                    <input type="text" id="manualLogAction" placeholder="A√ß√£o" className="w-full p-2 rounded bg-black/50 text-white mt-2"/>
                    <textarea id="manualLogDetails" rows={3} placeholder="Detalhes" className="w-full p-2 rounded bg-black/50 text-white mt-2"></textarea>
                    <button className="mt-2 bg-fuchsia-600 text-white p-2 rounded">Registrar</button>
                </div>
            </div>
        </div>
        
        {/* Overlays e Popups */}
        <div id="customMessageBoxOverlay" className="fixed inset-0 bg-black/70 items-center justify-center" style={{display: 'none'}}>
            <div id="customMessageBox" className="bg-slate-800 border-2 border-amber-400 rounded-xl p-8 text-center max-w-md">
                <h3 id="messageBoxTitle" className="text-2xl text-amber-400 mb-4"></h3>
                <p id="messageBoxContent" className="text-white mb-6"></p>
                <button className="bg-amber-400 text-black px-6 py-2 rounded">OK</button>
            </div>
        </div>
    </div>
  );
}
