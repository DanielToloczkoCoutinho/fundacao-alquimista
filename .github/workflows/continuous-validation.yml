name: Continuous Validation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  smoke-tests:
    name: "âš¡ Rito de FumaÃ§a - Auto-ValidaÃ§Ã£o"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      redis:
        image: redis:7-alpine
        ports: ["6379:6379"]
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ğŸ“¥ Checkout do CÃ³digo Sagrado
        uses: actions/checkout@v4

      - name: âš™ï¸ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ“¦ Instalar DependÃªncias do Templo
        run: |
          npm ci
          cd backend && npm ci

      - name: ğŸ—ï¸ Compilar Frontend
        run: npm run build

      - name: ğŸš€ Iniciar Backend
        run: |
          cd backend
          npm start &
          npx wait-on http://localhost:4000/health/extended --timeout 120000

      - name: ğŸŒ Iniciar Frontend
        run: |
          npm run start:test &
          npx wait-on http://localhost:3000 --timeout 60000

      - name: ğŸ” Executar Ritos de ValidaÃ§Ã£o
        run: |
          # Testar saÃºde do backend
          curl --fail http://localhost:4000/health/extended || exit 1
          
          # Testar portal do Firebase
          curl --fail http://localhost:3000/firebase-preview/ || exit 1
          
          # Testar API de saÃºde
          curl --fail http://localhost:3000/api/health || exit 1
          
          # Teste de resiliÃªncia avanÃ§ada
          timeout 30s bash -c '
            while true; do
              response=$(curl -s http://localhost:4000/health/extended)
              status=$(echo $response | jq -r ".status")
              
              if [ "$status" != "ok" ]; then
                echo "âŒ Sistema instÃ¡vel: status=$status"
                exit 1
              fi
              
              echo "âœ… Sistema estÃ¡vel: status=$status"
              sleep 3
            done
          '

      - name: ğŸ§¹ Limpeza RitualÃ­stica
        if: always()
        run: |
          npx kill-port 3000 || echo "Port 3000 not found"
          npx kill-port 4000 || echo "Port 4000 not found"
