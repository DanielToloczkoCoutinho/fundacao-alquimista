name: Continuous Validation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  smoke-tests:
    name: "⚡ Smoke Tests — Auto-Validação"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      redis:
        image: redis:7-alpine
        ports: ["6379:6379"]
        options: >
          --health-cmd "redis-cli ping" 
          --health-interval 10s 
          --health-timeout 5s 
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: |
          npm ci
          cd backend && npm ci

      - name: Build frontend
        run: npm run build

      - name: Start backend server
        run: |
          cd backend
          npm start &
          npx wait-on http://localhost:4000/health/extended --timeout 120000

      - name: Start frontend server
        run: |
          npm run start:test &
          npx wait-on http://localhost:3000 --timeout 60000

      - name: Execute smoke tests
        run: |
          curl --fail http://localhost:4000/health/extended || exit 1
          curl --fail http://localhost:3000/firebase-preview/ || exit 1
          curl --fail http://localhost:4000/health || exit 1
          
      - name: Cleanup
        if: always()
        run: |
          npx kill-port 3000 || echo "Port 3000 not found"
          npx kill-port 4000 || echo "Port 4000 not found"
